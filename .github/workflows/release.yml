name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.4"

      # go-winres runs in GoReleaser's before hooks; it works on Linux and generates .syso for the Windows binary (icon + version info).
      - name: Install go-winres (for Windows icon embedding)
        run: go install github.com/tc-hib/go-winres@latest

      - name: Run tests
        run: go test ./...

      - name: Validate GoReleaser config
        uses: goreleaser/goreleaser-action@v6
        with:
          version: '~> v2'
          args: check

      # GoReleaser builds the Chocolatey .nupkg on Linux (nupkg is just zip + nuspec + scripts; no Windows runner required).
      # Building here ensures the nupkg's install script checksum matches the zip we upload to GitHub.
      # Chocolatey skip_publish: true so we push from the chocolatey job (download nupkg from release, then dotnet nuget push).
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          SCOOP_BUCKET_TOKEN: ${{ secrets.SCOOP_BUCKET_TOKEN }}
          WINGET_PR_TOKEN: ${{ secrets.WINGET_PR_TOKEN }}

  chocolatey:
    name: Push Chocolatey package
    runs-on: ubuntu-latest
    needs: release
    permissions:
      contents: read

    steps:
      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/github-cli-apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update && sudo apt install gh -y

      - name: Download nupkg from GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Downloading *.nupkg from release $TAG"
          gh release download "$TAG" --pattern "*.nupkg" --dir nupkg
          ls -la nupkg/

      - name: Install .NET (for NuGet push)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Push to Chocolatey
        run: |
          NUPKG=$(ls nupkg/*.nupkg 2>/dev/null | head -1)
          if [ -z "$NUPKG" ]; then echo "No nupkg found"; exit 1; fi
          dotnet nuget push "$NUPKG" --api-key "$CHOCOLATEY_API_KEY" --source "https://push.chocolatey.org/" --force
        env:
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}